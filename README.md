# Распределённый калькулятор арифметических выражений

Онлайн-калькулятор для вычисления арифметических выражений с веб-интерфейсом. Позволяет вычислять математические выражения и сохраняет историю вычислений.

## Контакты
Telegram @int99

## Быстрый старт

### Первоначальная настройка проекта

При первом скачивании проекта из GitHub выполните следующие шаги:

1. **Установите Go версии 1.23 или выше (https://golang.org/dl/)**

2. **Скачайте зависимости проекта:**
   ```bash
   go mod download
   ```
3. **Запустите проект:**
   ```bash
   # Команда работает на Windows, Linux, macOS Ventura
   go run ./cmd/run/main.go
   ```
   в случае успешного запуска вы увидите соответствующий лог   
   ![log](docs/images/img_1.png)   
      
      ```json   
         Если сервис по каким-то причинам не стартанет, 
         например отобразится сообщение "Превышено время ожидания запуска оркестратора" и т.п.,
         то просто запустите сервис еще раз той же командой из пункта 3 'go run ./cmd/run/main.go'.
         Дело в том, что сервис не тестировался на всех операционных системах,
         поэтому сложно учесть все нюансы.
         Кроссплатформенное тестирование сервиса и отладка проводились только
         на Windows 11 Pro 23H2 x64 (go version go1.23.8 windows/amd64) и Mac OS Ventura
      ```

4. **После запуска сервиса откройте в браузере: http://localhost:8080**   
*Форма авторизации*   
![UI](docs/images/img_4.png)   
*Форма вычисления арифметических выражений*   
![img_1.png](docs/images/img_12.png)  


UI калькулятора будет доступен в браузере на порту, который указан в окружении в переменной ORCHESTRATOR_HTTP_PORT. По умолчанию это порт 8080
### Использование калькулятора

1. Зарегистрируйтесь новым пользователем или войдите в систему существующим пользователем (изначально в БД будет доступен один пользователь с кредами: admin/admin)
2. Введите математическое выражение в поле ввода
   - Пример сложного выражения: `((((10-20)*3+100)/35)*2)-0.05` (ожидаемый результат: 3.95)
3. Нажмите кнопку "Вычислить" или клавишу Enter
4. Просматривайте историю вычислений в таблице ниже
5. После перезапуска сервиса история вычислений сохраняется и подгружается из БД

## Возможности

- Вычисление математических выражений со скобками
- Поддержка операций сложения, вычитания, умножения и деления "+ - * /"
- Хранение истории вычислений для каждого пользователя
- Многопользовательский режим с аутентификацией (время жизни токена - 60 минут)

## Архитектура

Система состоит из трёх взаимодействующих компонентов:
- **Оркестратор** — обрабатывает запросы пользователей, разбивает выражения на подзадачи, взаимодействует с агентами через gRPC.
- **Агент** — выполняет отдельные арифметические операции, получает задачи от оркестратора по gRPC.
- **Сервис авторизации** — отвечает за регистрацию, вход, выдачу и валидацию JWT-токенов. Оркестратор проксирует к нему все запросы, связанные с аутентификацией пользователей.

## Системные требования

- Go 1.23 или выше
- Доступ к портам 8080 - 8083

## Тесты
В проекте тесты организованы по следующей структуре:

```
tests/
├── unit_tests/         # Модульные тесты
└── integration_tests/  # Интеграционные тесты
```

```bash
go test ./tests/...    # Запуск тестов
```
*Общее время выполнения тестов примерно 10 секунд*    
![img.png](docs/images/img_13.png)

## Очистка базы данных

Если нужно очистить все данные, можно удалить файл базы данных "calculator.db" соответствующей командой.   
Либо можно просто удалить файл "calculator.db" из проекта через контекстное меню.   
После удаления файла и перезапуска сервиса база данных будет пересоздана автоматически.

```bash
# Linux/macOS
rm calculator.db

# Windows
del calculator.db
```

## Настройка времени выполнения операций

Время задержки в миллисекундах (имитация вычислений) для каждой арифметической операции можно изменить через переменные окружения в файле `.env` в корне проекта:

- TIME_ADDITION_MS=400
- TIME_SUBTRACTION_MS=450
- TIME_MULTIPLICATIONS_MS=500
- TIME_DIVISIONS_MS=550

По умолчанию используются значения, указанные выше. Вы можете изменить их под свои нужды — например, чтобы замедлить или ускорить выполнение определённых операций.

## Проблемы и решения

### Windows
- Если порты 8080 - 8083 заняты, измените их в корне проекта в файле `.env`
- Убедитесь, что у вас установлен Go версии 1.21 или выше
- Если не запускается, проверьте права доступа к директории проекта
- Для проблем с портами используйте `sudo lsof -i :8080` для проверки не занят ли порт

## API Endpoints

Ниже представлены примеры всех API-эндпоинтов с примерами запросов через curl и возможными ответами.

### Регистрация пользователя

```bash
curl --location 'http://localhost:8080/api/v1/register' \
--header 'Content-Type: application/json' \
--data '{"login": "user1", "password": "password123"}'
```
**Пример успешного ответа (200 OK):**
```json
{
    "status": "success"
}
```
**Пример ошибки (400 Bad Request):**
```json
{
    "error": "Пользователь с таким логином уже существует"
}
```

---

### Авторизация

```bash
curl --location 'http://localhost:8080/api/v1/login' \
--header 'Content-Type: application/json' \
--data '{"login": "admin", "password": "admin"}'
```
**Пример успешного ответа (200 OK):**
```json
{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "status": "success"
}
```
**Пример ошибки (401 Unauthorized):**
```json
{
    "error": "Неверный логин или пароль"
}
```

---

### Получение информации о токене

```bash
curl --location 'http://localhost:8080/api/v1/token-info' \
--header 'Authorization: Bearer <ваш_токен>'
```
**Пример успешного ответа (200 OK):**
```json
{
    "expirationMinutes": "60"
}
```
**Пример ошибки (401 Unauthorized):**
```json
{
    "error": "Unauthorized"
}
```
---

### Вычисление выражения

```bash
curl --location 'http://localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer <ваш_токен>' \
--data '{"expression": "2+2*2"}'
```
![curl](docs/images/img_3.png)

**Пример успешного ответа (202 Accepted):**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "expression": "2+2*2",
    "status": "PROCESSING"
}
```
**Пример ошибки (422 Unprocessable Entity):**
```json
{
    "error": "Invalid expression: division by zero"
}
```
**Пример ошибки (401 Unauthorized):**
```json
{
    "error": "Unauthorized"
}
```
---

### Получение результата выражения по id

```bash
curl --location 'http://localhost:8080/api/v1/expressions/550e8400-e29b-41d4-a716-446655440000' \
--header 'Authorization: Bearer <ваш_токен>'
```
**Пример успешного ответа (COMPLETED):**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "original": "2+2*2",
    "status": "COMPLETED",
    "result": 6,
    "created_at": "01.01.2023 12:34:56"
}
```
**Пример ответа, если вычисление ещё идёт (PROCESSING):**
```json
{
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "original": "2+2*2",
    "status": "PROCESSING",
    "result": 0,
    "created_at": "01.01.2023 12:34:56"
}
```
**Пример ошибки (404 Not Found):**
```json
{
    "error": "Expression not found"
}
```
**Пример ошибки (401 Unauthorized):**
```json
{
    "error": "Unauthorized"
}
```
---

### Получение истории вычислений пользователя из БД

```bash
curl --location 'http://localhost:8080/api/v1/history' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```
**Пример успешного ответа (200 OK):**
```json
{
    "expressions": [
        {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "original": "2+2*2",
            "status": "COMPLETED",
            "result": 6,
            "created_at": "01.01.2023 12:34:56"
        }
    ]
}
```
**Пример ошибки (401 Unauthorized):**
```json
{
    "error": "Unauthorized"
}
```
---

### Получение всех выражений (история пользователя в пределах одной авторизационной сессии)

```bash
curl --location 'http://localhost:8080/api/v1/expressions' \
--header 'Authorization: Bearer <ваш_токен>'
```
**Пример успешного ответа (200 OK):**
```json
{
    "expressions": [
        {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "original": "2+2*2",
            "status": "COMPLETED",
            "result": 6,
            "created_at": "01.01.2023 12:34:56"
        }
    ]
}
```
**Пример ошибки (401 Unauthorized):**
```json
{
    "error": "Unauthorized"
}
```